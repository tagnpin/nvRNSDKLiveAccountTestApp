name: Android CI â€“ Optimized Debug Build

on:
  push:
    branches: [ stage ]
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'app.json'
      - 'index.js'
      - 'App.tsx'
      - 'babel.config.js'
      - 'tsconfig.json'
      - '.github/workflows/android.yml'

jobs:
  build-android-debug:
    name: Build Optimized Debug APK
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout Code
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js & Auto Cache NPM
      - name: ðŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      # 3ï¸âƒ£ Install Dependencies (Clean & Fresh)
      - name: ðŸ“¥ Install Dependencies
        run: |
          echo "ðŸ§¹ Removing old node_modules..."
          rm -rf node_modules
          echo "â¬‡ï¸ Installing packages..."
          npm ci --legacy-peer-deps

      # 4ï¸âƒ£ Setup Java 17
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: gradle

      # 5ï¸âƒ£ Setup Android SDK
      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v2

      # 6ï¸âƒ£ Cache Gradle (Improves Build Speed)
      - name: âš¡ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      # 7ï¸âƒ£ Enable Gradle Build Cache
      - name: ðŸš€ Enable Gradle Build Cache
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties

      # 8ï¸âƒ£ Force Hermes (Better Performance, Smaller Size)
      - name: âš™ï¸ Enable Hermes Runtime
        run: |
          if ! grep -q "enableHermes" android/app/build.gradle; then
            echo "project.ext.react = [ enableHermes: true ]" >> android/app/build.gradle
          fi

      # 9ï¸âƒ£ Bundle React Native JS
      - name: ðŸ“¦ Bundle React Native JS
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res/

      # ðŸ”Ÿ Build Split-ABI Debug APK
      - name: ðŸ— Build Split ABI Debug APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew clean assembleDebug \
            -PreactNativeArchitectures=armeabi-v7a,arm64-v8a,x86_64 \
            -PsplitApkByAbi=true \
            --no-daemon --parallel --build-cache --warning-mode all

      # 1ï¸âƒ£1ï¸âƒ£ Remove Bundle Source Map (Optional)
      - name: ðŸ§¹ Remove Bundle Source Map
        run: rm -f android/app/src/main/assets/index.android.bundle.map || true

      # 1ï¸âƒ£2ï¸âƒ£ Show APK Output Path
      - name: ðŸ“ Show APK Files
        run: ls -lh android/app/build/outputs/apk/debug/

      # 1ï¸âƒ£3ï¸âƒ£ Upload APK to GitHub Artifacts
      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-split
          path: android/app/build/outputs/apk/debug/*.apk

      # 1ï¸âƒ£4ï¸âƒ£ Upload APK to AWS S3 (Optional)
      - name: â˜ï¸ Upload APK to S3
        if: success()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          APK_PATH: android/app/build/outputs/apk/debug/*.apk
          S3_DESTINATION: ${{ github.event.repository.name }}/debug-${{ github.run_number }}.apk
        run: |
          echo "ðŸ” Checking APK at $APK_PATH..."
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            exit 1
          fi

          echo "â˜ï¸ Uploading APK to S3..."
          aws s3 cp "$APK_PATH" "s3://$S3_BUCKET/$S3_DESTINATION"

          APK_URL=$(aws s3 presign s3://$S3_DESTINATION --expires-in 604800)
          echo "âœ… Upload complete!"
          echo "ðŸ”— APK URL (valid 7 days): $APK_URL"
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
