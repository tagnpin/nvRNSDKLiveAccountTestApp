name: Android CI üöÄ Unified Build Pipeline
run-name: üîÑ Android ${{ vars.RN_ANDROID_BUILD_TYPE }} Build ‚Ä¢ Commit ${{ github.sha }}

on:
  push:
    branches: [ stage ]
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'app.json'
      - 'index.js'
      - 'App.tsx'
      - 'babel.config.js'
      - 'tsconfig.json'
      - '.github/workflows/android.yml'

jobs:
  build-android:
    name: Android Build (${{ vars.RN_ANDROID_BUILD_TYPE }})
    runs-on: ubuntu-latest

    env:
      BUILD_TYPE: ${{ vars.RN_ANDROID_BUILD_TYPE }}
      NV_BRAND_ID: ${{ secrets.NV_BRAND_ID }}
      NV_BRAND_ENCRYPTION_KEY: ${{ secrets.NV_BRAND_ENCRYPTION_KEY }}

    steps:

      #################################################################
      # 1Ô∏è‚É£ CHECKOUT PROJECT
      #################################################################
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      #################################################################
      # 2Ô∏è‚É£ SETUP NODE + INSTALL DEPENDENCIES
      #################################################################
      - name: üõ† Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: üì• Install Dependencies
        run: |
          rm -rf node_modules
          npm ci --legacy-peer-deps

      #################################################################
      # 3Ô∏è‚É£ JAVA + ANDROID SDK
      #################################################################
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 17
          cache: gradle

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v2

      #################################################################
      # 4Ô∏è‚É£ GRADLE CACHING
      #################################################################
      - name: ‚ö° Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: üöÄ Enable Gradle Build Cache
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties

      #################################################################
      # 5Ô∏è‚É£ BUNDLE REACT-NATIVE JS
      #################################################################
      - name: üì¶ Bundle React Native JS
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res/

      - name: üßπ Remove Source Map
        run: rm -f android/app/src/main/assets/index.android.bundle.map || true

      #################################################################
      # 6Ô∏è‚É£ RELEASE KEYSTORE DECODE (ONLY IN RELEASE MODE)
      #################################################################
      - name: üîê Decode Keystore (Release Only)
        if: env.BUILD_TYPE == 'release'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.RN_ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release-key.jks

      #################################################################
      # 7Ô∏è‚É£ ANDROID BUILD (SMART DEBUG/RELEASE)
      #################################################################
      - name: üèó Build Android App
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.RN_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.RN_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.RN_KEY_PASSWORD }}
        run: |
          chmod +x gradlew

          if [ "$BUILD_TYPE" = "debug" ]; then
            ./gradlew clean assembleDebug \
              -PreactNativeArchitectures=armeabi-v7a,arm64-v8a,x86_64 \
              -PsplitApkByAbi=true \
              --no-daemon --parallel
          else
            ./gradlew clean assembleRelease bundleRelease --no-daemon --parallel
          fi

      #################################################################
      # 8Ô∏è‚É£ SHOW OUTPUT FILES (SAFE, NO SECRET LEAK)
      #################################################################
      - name: üìÅ Show Build Outputs
        run: |
          ls -lh android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/ || true
          ls -lh android/app/build/outputs/bundle/release/ || true

      #################################################################
      # 9Ô∏è‚É£ UPLOAD ARTIFACTS (APK OR APK+AAB)
      #################################################################
      - name: üì§ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ env.BUILD_TYPE }}
          path: |
            android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/app-${{ env.BUILD_TYPE }}.apk
            android/app/build/outputs/bundle/release/app-release.aab

      #################################################################
      # üîü OPTIONAL: UPLOAD APK TO S3
      #################################################################
      - name: ‚òÅÔ∏è Upload APK to S3
        if: success()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          APK_PATH: android/app/build/outputs/apk/${{ env.BUILD_TYPE }}/app-${{ env.BUILD_TYPE }}.apk
          S3_DESTINATION: ${{ github.event.repository.name }}/${{ env.BUILD_TYPE }}-${{ github.run_number }}.apk
        run: |
          if [ -f "$APK_PATH" ]; then
            aws s3 cp "$APK_PATH" "s3://$S3_BUCKET/$S3_DESTINATION"
            URL=$(aws s3 presign "s3://$S3_BUCKET/$S3_DESTINATION" --expires-in 604800)
            echo "apk_url=$URL" >> $GITHUB_OUTPUT
          fi

      #################################################################
      # 1Ô∏è‚É£1Ô∏è‚É£ CLEANUP (REMOVE KEYSTORE)
      #################################################################
      - name: üßπ Cleanup Keystore
        if: env.BUILD_TYPE == 'release'
        run: rm -f android/app/release-key.jks
