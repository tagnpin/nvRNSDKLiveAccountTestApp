name: iOS CI ‚Äì Build & Upload to TestFlight

on:
  push:
    branches: [ stage ]
    paths:
      - 'ios/**'
      - 'pf_ios/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'app.json'
      - 'index.js'
      - 'App.tsx'
      - 'babel.config.js'
      - 'tsconfig.json'
      - '.github/workflows/ios.yml'

jobs:
  ios-build:
    name: üì± iOS Build & TestFlight Upload
    runs-on: macos-latest

    env:
      CI: true
      USE_HERMES: "1"
      NO_FLIPPER: "1"
      RCT_NO_LAUNCH_PACKAGER: "true"

      # Xcode Project Config
      APP_SCHEME: nvRNSDKLiveAccountTestApp
      WORKSPACE: nvRNSDKLiveAccountTestApp.xcworkspace
      CONFIGURATION: app_store
      DEVELOPMENT_TEAM: 4JW4924F8P

      # Provisioning Profile Names (must match Xcode)
      PROFILE_APP_NAME: nvRNLiveAcTestAppMainTargetReleaseDistribProfile
      PROFILE_EXT_NAME: nvRNLiveAcTestAppServicExtTargetReleaseDistProfile

      # ASC Keys (stored as secrets)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

    steps:
    # ---------------------------------------------------
    # 1. Checkout
    # ---------------------------------------------------
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # 2. Node Setup
    # ---------------------------------------------------
    - name: üü¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # ---------------------------------------------------
    # 3. Cache node_modules
    # ---------------------------------------------------
    - name: üì¶ Cache Node Modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          nvRNSDKLiveAccountTestApp/node_modules
        key: node-${{ runner.os }}-${{ hashFiles('nvRNSDKLiveAccountTestApp/package-lock.json') }}
        restore-keys: |
          node-${{ runner.os }}-

    # ---------------------------------------------------
    # 4. Install JS Dependencies
    # ---------------------------------------------------
    - name: üì• Install JavaScript Dependencies
      run: npm ci --legacy-peer-deps

    # ---------------------------------------------------
    # 5. Install iOS Pods
    # ---------------------------------------------------
    - name: üìö Install CocoaPods
      run: |
        cd ios
        pod install --repo-update

    # ---------------------------------------------------
    # 6. Auto-Increment Build Number
    # ---------------------------------------------------
    - name: üî¢ Update iOS Build Number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ios/${APP_SCHEME}/Info.plist

    # ---------------------------------------------------
    # 7. Decrypt Certificates & Profiles
    # ---------------------------------------------------
    - name: üîê Decrypt Certificates
      env:
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        mkdir -p ios/certs
        for f in appleDistribution.p12 main_Target_release.mobileprovision ext_Target_release.mobileprovision; do
          openssl aes-256-cbc -k "$CERT_PASSWORD" -in "pf_ios/${f}.enc" -out "ios/certs/${f}" -d
        done

    # ---------------------------------------------------
    # 8. Configure Keychain
    # ---------------------------------------------------
    - name: üîë Setup Keychain
      env:
        CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
      run: |
        KEYCHAIN=build.keychain
        security create-keychain -p "$CERT_PASSWORD" "$KEYCHAIN"
        security unlock-keychain -p "$CERT_PASSWORD" "$KEYCHAIN"
        security import ios/certs/appleDistribution.p12 -k "$KEYCHAIN" -P "$CERT_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" "$KEYCHAIN"

    # ---------------------------------------------------
    # 9. Install Provisioning Profiles
    # ---------------------------------------------------
    - name: üìÑ Install Provisioning Profiles
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp ios/certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles

    # ---------------------------------------------------
    # 10. Bundle React Native JS
    # ---------------------------------------------------
    - name: üì¶ Bundle React Native JS
      run: |
        npx react-native bundle \
          --platform ios \
          --entry-file index.js \
          --bundle-output ios/main.jsbundle \
          --assets-dest ios

    # ---------------------------------------------------
    # 11. Install xcpretty
    # ---------------------------------------------------
    - name: üíé Install xcpretty
      run: gem install xcpretty

    # ---------------------------------------------------
    # 12. Build & Archive with Xcode
    # ---------------------------------------------------
    - name: üèóÔ∏è Build & Archive iOS App
      run: |
        cd ios
        mkdir -p build

        cp ../pf_ios/ExportOptions.plist ExportOptions.plist

        xcodebuild \
          -workspace "$WORKSPACE" \
          -scheme "$APP_SCHEME" \
          -configuration "$CONFIGURATION" \
          -sdk iphoneos \
          -archivePath "build/${APP_SCHEME}.xcarchive" \
          DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          archive | xcpretty

        xcodebuild -exportArchive \
          -archivePath "build/${APP_SCHEME}.xcarchive" \
          -exportPath "build/export" \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates | xcpretty

    # ---------------------------------------------------
    # 13. Upload IPA to TestFlight
    # ---------------------------------------------------
    - name: üöÄ Upload IPA to TestFlight
      run: |
        echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > AuthKey.p8

        printf "{\n\"key_id\":\"%s\",\n\"issuer_id\":\"%s\",\n\"key\":\"%s\",\n\"in_house\":false\n}\n" \
          "$APP_STORE_CONNECT_API_KEY_ID" \
          "$APP_STORE_CONNECT_ISSUER_ID" \
          "$(awk '{printf "%s\\n", $0}' AuthKey.p8)" \
          > fastlane_api_key.json

        sudo gem install fastlane -N

        fastlane deliver \
          --api_key_path fastlane_api_key.json \
          --ipa ios/build/export/*.ipa \
          --skip_screenshots \
          --skip_metadata \
          --skip_app_version_update \
          --submit_for_review false \
          --force

    # ---------------------------------------------------
    # 14. Upload IPA as GitHub Artifact
    # ---------------------------------------------------
    - name: ‚òÅÔ∏è Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifact
        path: ios/build/export/*.ipa
