name: iOS Release CI - Build

on:
  push:
    branches: [ stage ]
    paths:
      - 'ios/**'
      - 'pf_ios/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'app.json'
      - 'index.js'
      - 'App.tsx'
      - 'babel.config.js'
      - 'tsconfig.json'
      - '.github/workflows/ios.yml'
      - 'react-native-notifyvisitors/**'

jobs:
  build-ios:
    name: ğŸ§± Build iOS (Release)
    runs-on: macos-latest

    env:
      # ğŸ§© Global Build Environment
      CI: true
      USE_HERMES: "1"
      RCT_NO_LAUNCH_PACKAGER: "true"
      NO_FLIPPER: "1"

      # ğŸ“± Xcode Configuration
      APP_SCHEME: nvRNSDKLiveAccountTestApp
      WORKSPACE: nvRNSDKLiveAccountTestApp.xcworkspace
      CONFIGURATION: app_store
      DEVELOPMENT_TEAM: 4JW4924F8P
      PROFILE_APP_NAME: nvRNLiveAcTestAppMainTargetReleaseDistribProfile
      PROFILE_EXT_NAME: nvRNLiveAcTestAppServicExtTargetReleaseDistProfile

      # App Store Connect API Keys (from GitHub Secrets)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

    steps:
      # -------------------------
      # 1ï¸âƒ£ Checkout Repository
      # -------------------------
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------
      # 2ï¸âƒ£ Setup Node
      # -------------------------
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------
      # 3ï¸âƒ£ Cache Dependencies
      # -------------------------
      - name: ğŸ“¦ Cache npm & node_modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            nvRNSDKLiveAccountTestApp/node_modules
          key: node-${{ runner.os }}-${{ hashFiles('nvRNSDKLiveAccountTestApp/package-lock.json') }}
          restore-keys: |
            node-${{ runner.os }}-

      # -------------------------
      # 4ï¸âƒ£ Install JS Dependencies
      # -------------------------
      - name: ğŸ“¦ Install JS Dependencies
        run: npm ci --legacy-peer-deps

      # -------------------------
      # 5ï¸âƒ£ Prepare iOS Dependencies
      # -------------------------
      - name: ğŸ§° Prepare iOS Dependencies (Pods & Fixes)
        run: |
          echo "ğŸ§¹ Cleaning old builds..."
          rm -rf ~/Library/Developer/Xcode/DerivedData ios/build ios/Pods

          echo "ğŸ“¦ Installing iOS Pods..."
          cd ios
          pod install --repo-update

          echo "ğŸ”§ Fixing Hermes & CocoaPods permissions..."
          find Pods -type f -name "Script-*.sh" -exec chmod +x {} \;
          chmod +x Pods/Target\ Support\ Files/Pods-*/Pods-*-frameworks.sh || true
          chmod +x Pods/Target\ Support\ Files/Pods-*/Pods-*-resources.sh || true

          echo "ğŸš« Disabling dependency analysis..."
          sed -i '' 's/"basedOnDependencyAnalysis" = YES;/"basedOnDependencyAnalysis" = NO;/g' \
            nvRNSDKLiveAccountTestApp.xcodeproj/project.pbxproj

          cd ..

      # -------------------------------------------------
      # 6ï¸âƒ£ Auto-Increment Build Number
      # -------------------------------------------------
      - name: ğŸ”¢ Auto-Increment iOS Build Number
        run: |
          BUILD_NUMBER="${{ github.run_number }}"
          echo "Using CFBundleVersion: $BUILD_NUMBER"
          plutil -replace CFBundleVersion -string "$BUILD_NUMBER" ios/nvRNSDKLiveAccountTestApp/Info.plist

      # -------------------------
      # 7ï¸âƒ£ Decrypt Signing Assets
      # -------------------------
      - name: ğŸ” Decrypt Signing Assets
        env:
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          mkdir -p ios/certs
          for FILE in appleDistribution.p12 main_Target_release.mobileprovision ext_Target_release.mobileprovision; do
            echo "ğŸ”“ Decrypting $FILE..."
            openssl aes-256-cbc -k "$CERT_PASSWORD" \
              -in "pf_ios/${FILE}.enc" -out "ios/certs/${FILE}" -d
          done

      # -------------------------
      # 8ï¸âƒ£ Configure Keychain
      # -------------------------
      - name: ğŸ”‘ Setup Keychain & Import Certificate
        env:
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          KEYCHAIN_NAME=build.keychain

          security create-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 3600 "$KEYCHAIN_NAME"
          security list-keychains -s "$KEYCHAIN_NAME"
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$CERT_PASSWORD" "$KEYCHAIN_NAME"

          echo "ğŸ“¥ Importing Distribution Certificate..."
          security import ios/certs/appleDistribution.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" "$KEYCHAIN_NAME"

      # -------------------------
      # 9ï¸âƒ£ Install Provisioning Profiles
      # -------------------------
      - name: ğŸ“„ Install Provisioning Profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios/certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles

      # -------------------------
      # ğŸ”Ÿ Bundle React Native JS
      # -------------------------
      - name: ğŸ“¦ Bundle React Native JS
        run: |
          npx react-native bundle \
            --entry-file index.js \
            --platform ios \
            --dev false \
            --bundle-output ios/main.jsbundle \
            --assets-dest ios

      # -------------------------
      # 1ï¸âƒ£1ï¸âƒ£ Install xcpretty
      # -------------------------
      - name: ğŸ’ Install xcpretty
        run: gem install xcpretty

      # -------------------------
      # 1ï¸âƒ£2ï¸âƒ£ Build & Archive App
      # -------------------------
      - name: ğŸ—ï¸ Build & Archive iOS App (AdHoc)
        run: |
          cd ios
          mkdir -p build

          echo "ğŸ§¹ Cleaning previous build..."
          xcodebuild clean -workspace "$WORKSPACE" -scheme "$APP_SCHEME" -configuration "$CONFIGURATION"

          echo "ğŸ“¥ Copying ExportOptions.plist..."
          cp ../pf_ios/ExportOptions.plist ExportOptions.plist

          echo "ğŸ“¦ Archiving app..."
          ARCHIVE_PATH="$PWD/build/${APP_SCHEME}.xcarchive"

          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$APP_SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            -allowProvisioningUpdates \
            archive | xcpretty

          echo "ğŸ“¦ Exporting .ipa..."
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$PWD/build/export" \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -verbose | tee export.log

          echo "âœ… Generated IPA files:"
          ls -la build/export/*.ipa

      # -------------------------------------------------
      # 1ï¸âƒ£3ï¸âƒ£ Upload IPA to TestFlight (Fastlane Deliver)
      # -------------------------------------------------
      - name: ğŸš€ Upload IPA to TestFlight
        run: |
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > AuthKey.p8

          KEY_CONTENT=$(awk '{printf "%s\\n", $0}' AuthKey.p8 | sed 's/"/\\"/g')

          cat > fastlane_api_key.json <<EOF
          {
            "key_id": "$APP_STORE_CONNECT_API_KEY_ID",
            "issuer_id": "$APP_STORE_CONNECT_ISSUER_ID",
            "key": "$KEY_CONTENT",
            "in_house": false
          }
          EOF

          sudo gem install fastlane -N

          fastlane deliver \
            --api_key_path fastlane_api_key.json \
            --ipa ios/build/export/*.ipa \
            --skip_screenshots \
            --skip_metadata \
            --run_precheck_before_submit false \
            --force \
            --verbose

      # -------------------------
      # 1ï¸âƒ£4ï¸âƒ£ Upload IPA Artifact
      # -------------------------
      - name: â˜ï¸ Upload iOS IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-adhoc-build
          path: ios/build/*.ipa
